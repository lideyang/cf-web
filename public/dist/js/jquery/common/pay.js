define(function(require,exports,module){function e(){var e=$(".checkboxOff");e.click(function(){if($self=$(this),!$self.hasClass("chkDisabled")){var e=$(this).find("input");$self.hasClass("checkboxOn")?($self.removeClass("checkboxOn"),e.attr("checked",!1).prop("checked",!1)):($self.addClass("checkboxOn"),e.attr("checked",!0).prop("checked",!0)),console.log(e.attr("checked"))}})}function a(){var e=$("#qpaypassInput").val();needPasswordCtrl&&null!=pgeditor&&$.ajax({url:basePath+"/getMcryptKey.json",type:"GET",async:!1,cache:!1,success:function(a){"pwd"==m&&(pgeditor.pwdSetSk(a.data),e=pgeditor.pwdResult(),$("#qpaypassInput").val(e),""!=e&&$("#realPayPwd").val(e))}})}var $=require("jquery"),t=require("tools");require("jquery.validate"),require("jquery.loadingBtn"),require("jquery.antiTamper");var n,r=$("#qpayLayer").html(),i=$("#reQpayLayer").html();$("#qpayLayer").empty(),$("#reQpayLayer").empty();var s=$("#firstBankList"),o="",d="",l="",c="",u=$("#bankList").find(".rechargeBank").first(),p="",m="pwd",f={title:"充值",addBankUrl:basePath+"/person/account/agreement.json",rechargeUrl:basePath+"/recharge/recharge.json",rechargeResultUrl:basePath+"/recharge/",dataType:"POST"};module.exports;module.exports={config:function(e){f=$.extend({},f,e)},init:function(){t.moneyFixInput(),"undefined"!=typeof u.attr("data-bankcode")?u.addClass("rechargeBankOn").find(".radioOff").addClass("radioOn"):(u.removeClass("rechargeBankOn").find(".radioOff").removeClass("radioOn"),$("#bankList").find(".radioOff").each(function(){if("undefined"!=typeof $(this).attr("data-bankcode"))return $(this).addClass("radioOn").parent().addClass("rechargeBankOn"),!1})),$(function(){var e=$("#bankList").find(".rechargeBankOn");if(e.length)e.click();else{var a=$("#bankList").find('.rechargeBank[name="netBank"]');a.length?a.first().click():$("#repayBtn").click()}}),s.on("click",".chooseBank",function(){$(this).hasClass("rechargeBankOff")||(s.find(".radioOff").removeClass("radioOn"),s.find(".rechargeBank").removeClass("rechargeBankOn"),o=$(this).addClass("rechargeBankOn").children(".radioOff").addClass("radioOn").next()[0].outerHTML,d=$(this).children(".radioOn").attr("data-bankcode"),l=$(this).children(".radioOn").attr("data-bankname"),void 0==d||parseInt(d)<=0?$("#payWay").val("ACCOUNT"):$("#payWay").val("QPAY"),$("#firstBankCode").val(d))}),$("#firstBankBtn").on("click",function(a){if("REAL"!=isCert)return layer.msg("您还未实名认证,请先完成实名认证过程!",{icon:5,time:2e3},function(){window.location.href=basePath+"/realInfo/realInfoStep0.htm"}),a.preventDefault(),!1;if(1!=checknetBankSubmit())return!1;if(""!=$("#firstBankCode").val()){layer.open({type:1,area:["545px","480px"],closeBtn:1,title:"快捷支付",shade:.6,moveType:1,shift:1,content:r,success:function(){needPasswordCtrl&&null!=pgeditor&&pgeditor.pwdTan("myInput fl loginInput loginNormalInput"),$li=$("#qpayLayerBoxer").find("li"),$li.eq(0).css("display","none"),$li.eq(1).css("display","block"),$("#bankImg").html(o),$("#qbankCode").val(d),$("#qpayBankCode").val(d),$("#qpayBankName").val(l),$("#amtDouble").val($("#amtB").val()),e(),module.exports.addBank.validateForm()},cancel:function(){needPasswordCtrl&&null!=pgeditor&&pgeditor.pwdClose("30px","172px","1px solid #cdcccb"),$("input[name='key']").val("")}})}else layer.msg("请选择银行卡",{icon:5});return!1}),$("#tradeForm").on("click",".typeList",function(){$("#tradeForm").find(".typeList").each(function(){$(this).removeClass("checkboxOn").parent().next().slideUp()}),$(this).addClass("checkboxOn").parent().next().slideDown()}),$("[name='netBank']").find(".rechargeBank").on("click",function(){$("[name='bankTips']").hide()}),$("#qpaySubmit,#addBankBtn").on("click",function(){$("input[name='key']").val("")})},addBank:{init:function(){require("jquery.CountDown"),$("#addBankBtn").on("click",function(){if(1!=checknetBankSubmit())return!1;var a=layer.open({type:1,area:["745px","480px"],closeBtn:1,title:"快捷支付",shade:.6,moveType:1,shift:1,content:r,success:function(){needPasswordCtrl&&null!=pgeditor&&pgeditor.pwdTan("myInput fl loginInput loginNormalInput"),$("#qpayLayerBoxer").find("li").eq(0).css("display","block");var t=$("#qpayBankList"),n="",r="",i="";e(),t.on("click",".chooseBank",function(){$(this).hasClass("rechargeBankOff")||(t.find(".radioOff").removeClass("radioOn"),t.find(".rechargeBank").removeClass("rechargeBankOn"),n=$(this).addClass("rechargeBankOn").children(".radioOff").addClass("radioOn").next()[0].outerHTML,r=$(this).children(".radioOn").attr("data-bankcode"),i=$(this).children(".radioOn").attr("data-bankname"),$("#qbankId").val(r))}),$("#layerNextBtn").on("click",function(){if(""!=$("#qbankId").val()){var e=($(window).width()-545)/2;$("#bankImg").html(n),$("#qbankCode").val($("#qbankId").val()),$("#qpayBankCode").val($("#qbankId").val()),$("#amtDouble").val($("#amtB").val()),$("#qpayBankName").val(i),$(this).parentsUntil("li").parent().fadeOut().next().fadeIn(),layer.style(a,{width:"545px",left:e}),module.exports.addBank.validateForm()}else layer.msg("请选择银行卡",{icon:5})})},cancel:function(){needPasswordCtrl&&null!=pgeditor&&pgeditor.pwdClose("30px","172px","1px solid #cdcccb"),$("input[name='key']").val("")}})})},validateForm:function(){$("#addBankCardForm").validate({rules:{checkNum:{required:!0,byteRangeLength:[4,8]},mobile:{required:!0,isMobile:!0},bankCardNo:{required:!0,byteRangeLength:[12,22]},payPwd:{required:!0},agreeCheck:{required:!0}},messages:{checkNum:{required:"请输入短信验证码",byteRangeLength:"验证码不正确",remote:"手机验证码错误"},mobile:{required:"请输入手机号码",isMobile:"请输入正确的手机号码"},bankCardNo:{required:"请输入12-22位的银行卡号",byteRangeLength:"请输入正确的银行卡号"},payPwd:{required:"请输入支付密码"},agreeCheck:{required:"请同意协议"}},ignore:"#PWD",errorPlacement:function(e,a){$element=$(a),"agreeCheck"==$element.attr("id")?$(a).addClass("myInputBlur").parent().parent().find(".alertText").addClass("alertTextFocus").html("<em></em>").append(e).css("display","inline"):$(a).addClass("myInputBlur").parent().find(".alertText").addClass("alertTextFocus").html("<em></em>").append(e).css("display","inline")},success:function(e,a){$element=$(a),"agreeCheck"==$element.attr("id")?$(a).removeClass("alertTextFocus myInputBlur").parent().parent().find(".alertText").removeClass("alertTextFocus").hide().empty():$element.removeClass("alertTextFocus myInputBlur").parent().find(".alertText").removeClass("alertTextFocus").hide().empty()},showErrors:function(){this.defaultShowErrors()},debug:!0,submitHandler:function(e){return $("#amtDouble").val($("#amtB").val()),$("#agreeBtnSubmit").loadingBtn({action:"start"}),$(e).find(".fake-form").remove(),p=$("#addBankCardForm").serialize(),$.ajax({url:f.addBankUrl,type:f.dataType,data:p,dataType:"json",async:!0,success:function(e,a,t){return console.log(e.code),"200"==e.code?($("#payWay").val("QPAY"),$("#bankActId").val(e.data),$("#passAmt").val($("#amtB").val()),$("#realPayPwd").val($("#payPwd").val()),module.exports.tradeAJAX()):"order-pay-check-code-confirm"==e.code?$("#agreeBtnSubmit").loadingBtn({action:"reset",defaultText:"同意开通并付款"}):(layer.msg(e.message,{icon:5,time:2e3},function(){}),$("#agreeBtnSubmit").loadingBtn({action:"reset",defaultText:"同意开通并付款"})),!1},error:function(){}}),!1}}),$("#sendSms").on("click",function(){$("#checkNum").rules("remove"),$("#payPwd").rules("remove");var e=$("#addBankCardForm").serializeArray();$("#addBankCardForm").valid()&&($("#amtDouble").val($("#amtB").val()),$("#sendSms").CountDown({data:e,start:!0,isMsg:!0,type:f.dataType,isSeed:!0,isClick:!1,time:6,isCallBack:"message",isUpdateDate:"#addBankCardForm",isMobile:"#mobile",isClear:"#checkNum",url:f.addBankUrl}))}),$("#agreeBtnSubmit").on("click",function(){$("#checkNum").rules("add",{required:!0,byteRangeLength:[4,8]}),$("#payPwd").rules("add",{required:!0})})}},quickPaySubmit:function(){$("#qpaySubmit").on("click",function(){var e=$("#qpayBanks").find(".radioOn");$("#bankCode").val();var a=e.attr("payWay"),n=e.attr("data-bankid"),r=e.attr("data-bankcode");if($("#payWay").val(a),$("#bankId").val(n),$("#bankCode").val(r),$("#tradeForm").attr("target",""),1!=checknetBankSubmit())return!1;if($("[name='bankTips']").css("display","none"),needPasswordCtrl){$.ajax({url:basePath+"/getMcryptKey.json?loginId="+loginId,type:"GET",async:!1,cache:!1,success:function(e){pgeditor.pwdSetSk(e.data)}});var i=pgeditor.pwdResult();$("#paypassInput").val(i)}var s=t.AjaxCheckPwd("/validatePayPwd.json",$("#paypassInput").val(),$("#paypassInput"));return!!s&&($("#realPayPwd").val($("#paypassInput").val()),$("#amtTips,#bankCode").hide(),$(this).loadingBtn({action:"start"}),void module.exports.tradeAJAX())})},netBankSubmit:function(){$("#netBankBtnSubmit").bind("click",function(){$("#bankCode").val($("[name='netBank']").find("span[class='radioOff radioOn']").attr("data-bankid"));var e=$("[name='netBank']").find("span[class='radioOff radioOn']").attr("payWay");return $("#payWay,#gateWayType").val(e),$("#tradeForm").attr("target","_blank"),1==checknetBankSubmit()&&($("[name='bankTips']").css("display","none"),""==$("#bankCode").val()?($("#netBankTips").css("display","block"),!1):($("#amtTips,#bankCode").hide(),n=layer.open({type:1,area:["500px","260px"],closeBtn:!1,title:f.title,shade:.6,moveType:1,shift:1,content:$("#popLayer").html()}),void $("#tradeForm").submit()))}),$("#amtA").on("blur",function(){var e=parseFloat($("#amtA").val()),a=/^[1-9]\d*$|^[1-9]\d*\.\d*$|0\.\d*[1-9]\d*$/;a.test(e)&&$("#amtTips").hide()})},tradeAJAX:function(){$.ajax({url:f.rechargeUrl,data:$("#tradeForm").serialize(),type:f.dataType,success:function(e,a,t){if("200"==e.code)window.location.href=f.rechargeResultUrl+e.data+"/success.htm";else if("bank-card-agreement-confirm"==e.code||"order-pay-check-code-confirm"==e.code){layer.closeAll(),$("#reCheckNum").val(""),$("#qpaySubmit").loadingBtn({action:"reset"}),$("#agreeBtnSubmit").loadingBtn({action:"reset",defaultText:"同意开通并付款"});var n=t.getResponseHeader("formToken");$("input[name='formToken']").val(n);layer.open({type:1,area:["545px","220px"],closeBtn:1,title:"快捷支付",shade:.6,moveType:1,shift:1,content:i,success:function(){module.exports.reValidateForm(),needPasswordCtrl&&pgeditor.pwdTan("myInput fl loginInput loginNormalInput")},cancel:function(){c=f.rechargeUrl,needPasswordCtrl&&pgeditor.pwdClose("30px","172px","1px solid #cdcccb"),$("input[name='key']").val("")}})}else null==e.data&&"500"==e.code?layer.msg(e.message,{icon:5},function(){window.location.reload()}):null!=e.data&&""!=e.data?window.location.href=f.rechargeResultUrl+e.data+"/success.htm":(e.message?layer.msg(e.message,{icon:5}):layer.msg("无法完成付款. 此订单订已经交易成功，请重新核实交易状态再付款",{icon:5}),status--);$("#qpaySubmit").loadingBtn({action:"reset",defaultText:"下一步"})}})},reValidateForm:function(){$("#reBankCardForm").validate({rules:{reCheckNum:{required:!0,byteRangeLength:[4,8]}},messages:{reCheckNum:{required:"请输入短信验证码",byteRangeLength:"验证码不正确",remote:"手机验证码错误"}},ignore:"#PWD",errorPlacement:function(e,a){$element=$(a),console.log($element.attr("id")),"agreeCheck"==$element.attr("id")?$(a).addClass("myInputBlur").parent().parent().find(".alertText").addClass("alertTextFocus").html("<em></em>").append(e).css("display","inline"):$(a).addClass("myInputBlur").parent().find(".alertText").addClass("alertTextFocus").html("<em></em>").append(e).css("display","inline")},success:function(e,a){$element=$(a),"agreeCheck"==$element.attr("id")?$(a).removeClass("alertTextFocus myInputBlur").parent().parent().find(".alertText").removeClass("alertTextFocus").hide().empty():$element.removeClass("alertTextFocus myInputBlur").parent().find(".alertText").removeClass("alertTextFocus").hide().empty()},showErrors:function(){this.defaultShowErrors()},debug:!0,submitHandler:function(e){$("#amtDouble").val($("#amtB").val()),a();var t=$("#tradeForm").serialize()+"&"+$("#reBankCardForm").serialize();return $("#reBtnSubmit").loadingBtn({action:"start"}),$.ajax({url:f.rechargeUrl,type:f.dataType,data:t,dataType:"json",async:!0,cache:!1,success:function(e,a,t){console.log(e.code),$("#reCheckNum").val(""),"200"==e.code?window.location.href=f.rechargeResultUrl+e.data+"/success.htm":"bank-card-agreement-confirm"==e.code||"order-pay-check-code-confirm"==e.code?($("#reBtnSubmit").loadingBtn({action:"reset",defaultText:"确认付款"}),e.message&&layer.msg(e.message,{icon:5})):(layer.msg(e.message,{icon:5,time:2e3},function(){}),$("#reBtnSubmit").loadingBtn({action:"reset",defaultText:"确认付款"}));var n=t.getResponseHeader("formToken");$("input[name='formToken']").val(n)},error:function(){}}),!1}}),$("#amtDouble").val($("#amtB").val()),$("#reSendSms").CountDown({data:$("#tradeForm").serialize(),start:!0,isMsg:!0,type:f.dataType,isSeed:!1,isClick:!0,time:60,isCallBack:"message",isClear:"#reCheckNum",isUpdateDate:"#tradeForm",isMobile:!1,beforeClick:function(){a()},isUpdateDate:"#tradeForm",tokenId:'input[name="formToken"]',successDataCode:"bank-card-agreement-confirm",url:f.rechargeUrl})},noSupportReeditCard:function(){$("#bankList").on("click",".rechargeBank",function(){if($radio=$(this).find(".radioOff"),!$radio.attr("data-bankcode"))return layer.msg("不支持信用卡"+f.title,{icon:2}),$radio.removeClass("radioOn"),$(this).removeClass("rechargeBankOn"),!1})}}});