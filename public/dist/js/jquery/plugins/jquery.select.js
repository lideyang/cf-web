define(function(require,exports,module){var t=require("jquery");!function($){function t(t,i){this._name=e,this.el=t,this.$el=$(t),this.$el.prop("multiple")||(this.settings=$.extend({},s,i,this.$el.data()),this._defaults=s,this.$options=this.$el.find("option, optgroup"),this.init(),$.fn[e].instances.push(this))}var e="comboSelect",i="comboselect",s={comboClass:"combo-select",comboArrowClass:"combo-arrow",comboDropDownClass:"combo-dropdown",inputClass:"combo-input text-input",disabledClass:"option-disabled",hoverClass:"option-hover",selectedClass:"option-selected",markerClass:"combo-marker",themeClass:"",maxHeight:200,extendStyle:!0,focusInput:!0,ajax:!1},n={ESC:27,TAB:9,RETURN:13,LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16},o=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase());$.extend(t.prototype,{init:function(){this._construct(),this._events()},_construct:function(){this.$el.data("plugin_"+i+"_tabindex",this.$el.prop("tabindex")),!o&&this.$el.prop("tabIndex",-1),this.$container=this.$el.wrapAll('<div class="'+this.settings.comboClass+" "+this.settings.themeClass+'" />').parent(),this.settings.extendStyle&&this.$el.attr("style")&&this.$container.attr("style",this.$el.attr("style")),this.$arrow=$('<div class="'+this.settings.comboArrowClass+'" />').appendTo(this.$container),this.$dropdown=$('<ul class="'+this.settings.comboDropDownClass+'" />').appendTo(this.$container),this._build(),this.$input=$('<input type="text"'+(o?'tabindex="-1"':"")+' placeholder="'+this.getPlaceholder()+'" class="'+this.settings.inputClass+'">').appendTo(this.$container),this._updateInput()},getPlaceholder:function(){var t="";return this.$options.filter(function(t,e){return"OPTION"==e.nodeName}).each(function(e,i){""==i.value&&(t=i.innerHTML)}),t},_build:function(){var t=this,e="",i=0;this.$options.each(function(s,n){return"optgroup"==n.nodeName.toLowerCase()?e+='<li class="option-group">'+this.label+"</li>":(e+='<li class="'+(this.disabled?t.settings.disabledClass:"option-item")+" "+(i==t.$el.prop("selectedIndex")?t.settings.selectedClass:"")+'" data-index="'+i+'" data-value="'+this.value+'">'+this.innerHTML+"</li>",void i++)}),this.$dropdown.html(e),this.$items=this.$dropdown.children()},_events:function(){this.$container.on("focus.input","input",$.proxy(this._focus,this)),this.$container.on("mouseup.input","input",function(t){t.preventDefault()}),this.$container.on("blur.input","input",$.proxy(this._blur,this)),this.$el.on("change.select",$.proxy(this._change,this)),this.$el.on("focus.select",$.proxy(this._focus,this)),this.$el.on("blur.select",$.proxy(this._blurSelect,this)),this.$container.on("click.arrow","."+this.settings.comboArrowClass,$.proxy(this._toggle,this)),this.$container.on("comboselect:close",$.proxy(this._close,this)),this.$container.on("comboselect:open",$.proxy(this._open,this)),this.$container.on("comboselect:update",$.proxy(this._update,this)),$("html").off("click.comboselect").on("click.comboselect",function(){$.each($.fn[e].instances,function(t,e){e.$container.trigger("comboselect:close")})}),this.$container.on("click.comboselect",function(t){}),this.$container.on("keydown","input",$.proxy(this._keydown,this)),this.$container.on("keyup","input",$.proxy(this._keyup,this)),this.$container.on("click.item",".option-item",$.proxy(this._select,this))},_keydown:function(t){switch(t.which){case n.UP:this._move("up",t);break;case n.DOWN:this._move("down",t);break;case n.TAB:this._enter(t);break;case n.RIGHT:this._autofill(t);break;case n.ENTER:this._enter(t)}},_keyup:function(t){switch(t.which){case n.ESC:this.$container.trigger("comboselect:close");break;case n.ENTER:case n.UP:case n.DOWN:case n.LEFT:case n.RIGHT:case n.TAB:case n.SHIFT:break;default:this._filter(t.target.value)}},_enter:function(t){var e=this._getHovered();if(e.length&&this._select(e),t&&t.which==n.ENTER){if(!e.length)return this._blur(),!0;t.preventDefault()}},_move:function(t){var e=this._getVisible(),i=this._getHovered(),s=i.prevAll(".option-item").filter(":visible").length,n=e.length;switch(t){case"up":s--,s<0&&(s=n-1);break;case"down":s++,s>=n&&(s=0)}e.removeClass(this.settings.hoverClass).eq(s).addClass(this.settings.hoverClass),this.opened||this.$container.trigger("comboselect:open"),this._fixScroll()},_select:function(t){var e=$(t.currentTarget?t.currentTarget:t);if(e.length){var i=e.data("index");this._selectByIndex(i),this.$input.focus(),this.$container.trigger("comboselect:close")}},_selectByIndex:function(t){"undefined"==typeof t&&(t=0),this.$el.prop("selectedIndex")!=t&&this.$el.prop("selectedIndex",t).trigger("change")},_autofill:function(){var t=this._getHovered();if(t.length){var e=t.data("index");this._selectByIndex(e)}},_ajax:function(t,e){var i=this;$.ajax({url:t,type:"GET",cache:!1,data:{toLogidId:e},success:function(t){if("200"==t.code){var s="",n="",t=t.data;if("string"==typeof t[0])for(var o in t)s+='<li class="option-item" data-index="'+o+'" data-value="'+t[o]+'">'+t[o]+"</li>",n+='<option value="'+t[o]+'">'+t[o]+"</option>";else for(var o in t)s+='<li class="option-item" data-index="'+o+'" data-value="'+t[o].linkLoginId+'">'+t[o].linkLoginId+"</li>",n+='<option value="'+t[o].linkLoginId+'">'+t[o].linkLoginId+"</option>";i.$dropdown.html(s),i.$el.html(n),i._update();var r=i._getAll();i._filterItems(r,e)}else layer.msg(t.message,{icon:5})}})},_filterItems:function(t,e){var i=new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g"),s=$.trim(e).toLowerCase();"("+e.replace(i,"\\$1")+")";$("."+this.settings.markerClass,t).contents().unwrap(),s?(this.$items.filter(".option-group, .option-disabled").hide(),t.hide().filter(function(){var t=$(this),e=$.trim(t.text()).toLowerCase();if(e.toString().indexOf(s)!=-1)return t.html(function(t,e){}),!0}).show()):this.$items.show(),this.$container.trigger("comboselect:open")},_filter:function(t){if(this.settings.ajax)this._ajax(this.settings.ajax,t);else{var e=this._getAll();this._filterItems(e,t)}},_highlight:function(){var t=this._getVisible().removeClass(this.settings.hoverClass),e=t.filter("."+this.settings.selectedClass);e.length?e.addClass(this.settings.hoverClass):t.removeClass(this.settings.hoverClass).first().addClass(this.settings.hoverClass)},_updateInput:function(){var t=this.$el.prop("selectedIndex");return this.$el.val()?(text=this.$el.find("option").eq(t).text(),this.$input.val(text)):this.$input.val(""),this._getAll().removeClass(this.settings.selectedClass).filter(function(){return $(this).data("index")==t}).addClass(this.settings.selectedClass)},_blurSelect:function(){this.$container.removeClass("combo-focus")},_focus:function(t){this.$container.toggleClass("combo-focus",!this.opened),o||(this.opened||this.$container.trigger("comboselect:open"),this.settings.focusInput&&t&&t.currentTarget&&"INPUT"==t.currentTarget.nodeName&&t.currentTarget.select())},_blur:function(){var t=$.trim(this.$input.val().toLowerCase()),e=!isNaN(t),i=this.$options.filter(function(){return"OPTION"==this.nodeName}).filter(function(){return e?parseInt($.trim($(this).text()).toLowerCase())==t:$.trim($(this).text()).toLowerCase()==t}).prop("index");if(void 0!=i)this._selectByIndex(i);else if(""!=t){var s='<option value="'+t+'">'+t+"</option>";this.$el.append(s),this._updateInput(),i=this.$options.filter(function(){return"OPTION"==this.nodeName}).filter(function(){return e?parseInt($.trim(this.innerText).toLowerCase())==t:$.trim(this.innerText).toLowerCase()==t}).prop("index"),this._selectByIndex(i)}var n=$.Event("blur.select");this.$el.trigger(n)},_change:function(){this._updateInput()},_getAll:function(){return this.$items.filter(".option-item")},_getVisible:function(){return this.$items.filter(".option-item").filter(":visible")},_getHovered:function(){return this._getVisible().filter("."+this.settings.hoverClass)},_open:function(){var t=this;this.$container.addClass("combo-open"),this.opened=!0,this.settings.focusInput&&setTimeout(function(){!t.$input.is(":focus")&&t.$input.focus()}),this._highlight(),this._fixScroll(),$.each($.fn[e].instances,function(e,i){i!=t&&i.opened&&i.$container.trigger("comboselect:close")})},_toggle:function(){this.opened?this._close.call(this):this._open.call(this)},_close:function(){this.$container.removeClass("combo-open combo-focus"),this.$container.trigger("comboselect:closed"),this.opened=!1,this.$items.show()},_fixScroll:function(){if(!this.$dropdown.is(":hidden")){var t=this._getHovered();if(t.length){var e,i,s,n=t.outerHeight();e=t[0].offsetTop,i=this.$dropdown.scrollTop(),s=i+this.settings.maxHeight-n,e<i?this.$dropdown.scrollTop(e):e>s&&this.$dropdown.scrollTop(e-this.settings.maxHeight+n)}}},_update:function(){this.$options=this.$el.find("option, optgroup"),this.$dropdown.empty(),this._build()},dispose:function(){this.$arrow.remove(),this.$input.remove(),this.$dropdown.remove(),this.$el.removeAttr("tabindex"),this.$el.data("plugin_"+i+"_tabindex")&&this.$el.prop("tabindex",this.$el.data("plugin_"+i+"_tabindex")),this.$el.unwrap(),this.$el.removeData("plugin_"+i),this.$el.removeData("plugin_"+i+"_tabindex"),this.$el.off("change.select focus.select blur.select")}}),$.fn[e]=function(e,s){return this.each(function(){var n=$(this),o=n.data("plugin_"+i);"string"==typeof e?o&&"function"==typeof o[e]&&o[e](s):(o&&o.dispose&&o.dispose(),$.data(this,"plugin_"+i,new t(this,e)))}),this},$.fn[e].instances=[]}(t)});